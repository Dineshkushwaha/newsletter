<?php

use Drupal\Core\Form\FormStateInterface;
use Drupal\node\Entity\Node;


/*
 * Implements hook_form_alter
 */
function sph_newsletter_form_alter(&$form, FormStateInterface $form_state, $form_id) {

    switch ($form_id) {
    case 'node_newsletter_edit_form':
      $form['actions']['launch'] = array(
        '#type' => 'submit',
        '#weight' => 999,
        '#limit_validation_errors' => array(),
        '#button_type' => 'submit',
        '#submit' => array(
          'sph_newsletter_node_form_submit'
        ),
        '#value' => t('Launch'),
      );
      break;
  }
}

function sph_newsletter_node_form_submit(&$form, FormStateInterface $form_state) {

  $nid = $form_state->getFormObject()->getEntity()->id();
  $emarsysValues = getEmarsysData($nid);

  $service = \Drupal::service('sph_newsletter.emarsys_services');
  $service->previewNewsletter($emarsysValues);
}

function getEmarsysData($nid) {

  $entity_type = 'node';
  $view_mode = 'full';
  $builder = \Drupal::entityTypeManager()->getViewBuilder($entity_type);
  $storage = \Drupal::entityTypeManager()->getStorage($entity_type);
  $node = $storage->load($nid);
  $build = $builder->view($node, $view_mode);
  $output = (string) render($build);
  $result = "<html><head></head>
               <body>$output</body>
             </html>";

  $newsLetterValues = [
      'name' => ($node->hasField('field_name')) ? $node->field_name->value . "_" . date('dmy_his') : '',
      'subject' => "hello subject",
      'language' => ($node->hasField('field_language')) ? $node->field_language->value : '',
      'fromemail' => ($node->hasField('field_from_email')) ? $node->field_from_email->value : '',
      'fromname' => ($node->hasField('field_from_name')) ? $node->field_from_name->value : '',
      'html_source' => $result,
      'browse' => 0,
      'text_only' => 0,
      'unsubscribe' => 1,
      'filter' => 221963
  ];
  return $newsLetterValues;
}
